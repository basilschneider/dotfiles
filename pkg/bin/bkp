#!/usr/bin/env bash

errorFile=~/bkp_error.txt
server=lxplus
dir=/afs/cern.ch/work/b/bschneid/private/.bkp/
plex=false
plexfolder=/var/lib/plexmediaserver/Library/Application\ Support/Plex\ Media\ Server

# Backup home folder
rsync \
    -pavz \
    --delete \
    --exclude 'mnt/' \
    --exclude '.cache/' \
    --exclude 'Videos/' \
    --exclude 'Music/' \
    --exclude 'Documents/vmware' \
    --exclude '.dropbox/command_socket' \
    --exclude '.dropbox/iface_socket' \
    --exclude '.moc/socket2' \
    /home/basil "$server":"${dir}" 2>> "$errorFile"
ssh lxplus "echo Last backup invoked at $(date) >> ${dir}/bkp.txt"

if [[ "$plex" == true ]]; then
    ### Backup plex folder
    sudo chmod -R a+r "$plexfolder" 2>> "$errorFile"
    rsync -pavz --delete "$plexfolder" "$server":~/bkp/ 2>> "$errorFile"
fi

# Check size of backup
echo -n "Back up size on server: "
ssh \
    -q \
    "${server}" du -sh "${dir}"basil | awk '{ print $1 }'

# Check if there were errors
if [[ -s "$errorFile" ]]; then
    echo "There were errors." 1>&2
else
    rm "$errorFile"
fi

echo "Bye."
exit 0
